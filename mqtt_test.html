<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Connection Test</title>
    <!-- Using local copy of Paho MQTT library (no internet required) -->
    <script src="paho-mqtt.min.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #00ff00;
        }
        .log {
            background-color: #000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #00aaff; }
        button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover { background-color: #00cc00; }
    </style>
</head>
<body>
    <h1>ðŸ”Œ MQTT Connection Diagnostic Tool</h1>
    
    <div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <h2>Connection Log:</h2>
    <div id="log" class="log"></div>

    <script>
        let client = null;
        let connected = false;
        
        // Check if Paho MQTT library loaded
        window.addEventListener('load', function() {
            if (typeof Paho === 'undefined' || typeof Paho.Client === 'undefined') {
                log('âœ—âœ—âœ— CRITICAL ERROR: Paho MQTT library failed to load! âœ—âœ—âœ—', 'error');
                log('Possible causes:', 'error');
                log('1. No internet connection', 'error');
                log('2. CDN blocked by firewall/proxy', 'error');
                log('3. File opened with file:// protocol (use http://)', 'error');
                log('SOLUTION: Run "./start_server.sh" and open http://localhost:8000/mqtt_test.html', 'info');
            } else {
                log('âœ“ Paho MQTT library loaded successfully', 'success');
                log('Page loaded. Click "Test Connection" to begin.', 'info');
            }
        });
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testConnection() {
            // Check if library is loaded
            if (typeof Paho === 'undefined' || typeof Paho.Client === 'undefined') {
                log('âœ— Cannot test: Paho MQTT library not loaded!', 'error');
                log('Please refresh the page or use a web server (./start_server.sh)', 'error');
                return;
            }
            
            log('=== Starting MQTT Connection Test ===', 'info');
            
            const brokerHost = "test.mosquitto.org";
            const brokerPort = 8081;
            const brokerPath = "/mqtt";
            const clientId = "test_" + Math.random().toString(16).substr(2, 8);
            
            log(`Creating client with ID: ${clientId}`, 'info');
            log(`Broker: wss://${brokerHost}:${brokerPort}${brokerPath}`, 'info');
            
            try {
                client = new Paho.Client(brokerHost, brokerPort, brokerPath, clientId);
                log('âœ“ Client created successfully', 'success');
                
                client.onConnectionLost = function(response) {
                    connected = false;
                    if (response.errorCode !== 0) {
                        log(`âœ— Connection lost: ${response.errorMessage}`, 'error');
                    } else {
                        log('Connection closed normally', 'info');
                    }
                };
                
                client.onMessageArrived = function(message) {
                    log(`ðŸ“¨ Message received: ${message.payloadString}`, 'success');
                };
                
                const connectOptions = {
                    useSSL: true,
                    timeout: 10,
                    keepAliveInterval: 30,
                    onSuccess: function() {
                        connected = true;
                        log('âœ“âœ“âœ“ CONNECTION SUCCESSFUL! âœ“âœ“âœ“', 'success');
                        log('Subscribing to test topic...', 'info');
                        client.subscribe("fleet/commands/navigate");
                        log('âœ“ Subscribed to fleet/commands/navigate', 'success');
                    },
                    onFailure: function(error) {
                        connected = false;
                        log(`âœ—âœ—âœ— CONNECTION FAILED! âœ—âœ—âœ—`, 'error');
                        log(`Error Code: ${error.errorCode}`, 'error');
                        log(`Error Message: ${error.errorMessage}`, 'error');
                        
                        // Common error codes
                        if (error.errorCode === 7) {
                            log('Tip: Error code 7 usually means WebSocket connection failed', 'info');
                            log('Check if the broker supports WebSocket on port 8081', 'info');
                        }
                    }
                };
                
                log('Attempting to connect...', 'info');
                client.connect(connectOptions);
                
            } catch (error) {
                log(`âœ— Exception: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }
        
        function sendTestMessage() {
            if (!connected || !client) {
                log('âœ— Not connected! Please test connection first.', 'error');
                return;
            }
            
            const testCommand = {
                robot_id: "SmallDeliveryRobot_0",
                goal: {
                    x: 5.0,
                    y: 3.0
                }
            };
            
            const payload = JSON.stringify(testCommand);
            log(`Sending test message: ${payload}`, 'info');
            
            try {
                const message = new Paho.Message(payload);
                message.destinationName = "fleet/commands/navigate";
                client.send(message);
                log('âœ“ Test message sent successfully!', 'success');
            } catch (error) {
                log(`âœ— Failed to send: ${error.message}`, 'error');
            }
        }
        
    </script>
</body>
</html>
